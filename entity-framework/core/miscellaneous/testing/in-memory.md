---
title: Тестирование с использованием EF Core памяти
author: rowanmiller
ms.date: 10/27/2016
ms.assetid: 0d0590f1-1ea3-4d5c-8f44-db17395cd3f3
uid: core/miscellaneous/testing/in-memory
ms.openlocfilehash: 18641677098c20d9172136b07868dcb647d189c6
ms.sourcegitcommit: cc0ff36e46e9ed3527638f7208000e8521faef2e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78414029"
---
# <a name="testing-with-inmemory"></a>Тестирование с помощью InMemory

Поставщик нехватки памяти полезен, если нужно протестировать компоненты с помощью чего-то, которое приблизительно подключается к реальной базе данных, без издержек на выполнение фактических операций с базой данных.

> [!TIP]  
> Для этой статьи вы можете скачать [пример](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Miscellaneous/Testing) из репозитория GitHub.

## <a name="inmemory-is-not-a-relational-database"></a>Неиспользуемая память не является реляционной базой данных

Поставщики баз данных EF Core не обязательно должны быть реляционными базами данных. Параметр "память" предназначен для использования в качестве базы данных общего назначения для тестирования и не предназначен для имитации реляционной базы данных.

Ниже приведены некоторые примеры.

* Параметр "память" позволяет сохранять данные, нарушающие ограничения ссылочной целостности в реляционной базе данных.
* Если для свойства в модели используется Дефаултвалуескл (строка), это API-интерфейс реляционной базы данных и не будет оказывать влияния при выполнении в памяти.
* [Параллелизм через отметку времени или версию строки](xref:core/modeling/concurrency#timestamprowversion) (`[Timestamp]` или `IsRowVersion`) не поддерживается. Если обновление выполняется с помощью старого маркера параллелизма, [дбупдатеконкурренциексцептион](https://docs.microsoft.com/dotnet/api/microsoft.entityframeworkcore.dbupdateconcurrencyexception) не создается.

> [!TIP]  
> Для многих целей тестирования эти различия не имеют значения. Тем не менее, если нужно протестировать нечто вроде реальной реляционной базы данных, рассмотрите возможность использования [SQLite в памяти](sqlite.md).

## <a name="example-testing-scenario"></a>Пример сценария тестирования

Рассмотрим следующую службу, которая позволяет коду приложения выполнять некоторые операции, связанные с блогами. На внутреннем уровне используется `DbContext`, который подключается к базе данных SQL Server. Было бы полезно переключить этот контекст для подключения к базе данных в памяти, чтобы мы могли написать эффективные тесты для этой службы, не изменяя код, или выполнить массовую работу по созданию тестовой двойной части контекста.

[!code-csharp[Main](../../../../samples/core/Miscellaneous/Testing/BusinessLogic/BlogService.cs)]

## <a name="get-your-context-ready"></a>Подготовка контекста

### <a name="avoid-configuring-two-database-providers"></a>Избегайте настройки двух поставщиков баз данных

В тестах вы собираетесь извне настроить контекст для использования поставщика памяти. При настройке поставщика базы данных путем переопределения `OnConfiguring` в контексте необходимо добавить некоторый условный код, чтобы убедиться, что поставщик базы данных настроен только в том случае, если он еще не настроен.

[!code-csharp[Main](../../../../samples/core/Miscellaneous/Testing/BusinessLogic/BloggingContext.cs#OnConfiguring)]

> [!TIP]  
> Если вы используете ASP.NET Core, этот код не нужен, так как поставщик базы данных уже настроен вне контекста (в Startup.cs).

### <a name="add-a-constructor-for-testing"></a>Добавление конструктора для тестирования

Самый простой способ включить тестирование в другой базе данных — изменить контекст, чтобы предоставить конструктор, принимающий `DbContextOptions<TContext>`.

[!code-csharp[Main](../../../../samples/core/Miscellaneous/Testing/BusinessLogic/BloggingContext.cs#Constructors)]

> [!TIP]  
> `DbContextOptions<TContext>` сообщает контексту все параметры, такие как база данных для подключения. Это тот же объект, который создается путем запуска метода onconfiguring в контексте.

## <a name="writing-tests"></a>Написание тестов

Ключом к тестированию с помощью этого поставщика является возможность указать контексту использование поставщика памяти и управлять областью базы данных в памяти. Обычно требуется чистая база данных для каждого метода теста.

Ниже приведен пример тестового класса, использующего базу данных в памяти. Каждый метод теста задает уникальное имя базы данных, то есть каждый метод имеет собственную базу данных, используемую в памяти.

>[!TIP]
> Чтобы использовать метод расширения `.UseInMemoryDatabase()`, укажите ссылку на пакет NuGet [Microsoft. EntityFrameworkCore. Memory](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.InMemory/).

[!code-csharp[Main](../../../../samples/core/Miscellaneous/Testing/TestProject/InMemory/BlogServiceTests.cs)]
