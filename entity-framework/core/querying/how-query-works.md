---
title: Как работают запросы — EF Core
author: rowanmiller
ms.date: 09/26/2018
ms.assetid: de2e34cd-659b-4cab-b5ed-7a979c6bf120
uid: core/querying/how-query-works
ms.openlocfilehash: ba0d68469530e6272ffbb51946d7856122a261c7
ms.sourcegitcommit: 18ab4c349473d94b15b4ca977df12147db07b77f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2019
ms.locfileid: "73656241"
---
# <a name="how-queries-work"></a>Как работают запросы

Entity Framework Core использует LINQ для запроса данных из базы данных. LINQ позволяет использовать C# (или предпочитаемый вами язык .NET) для написания строго типизированных запросов, основанных на производном контексте и классах сущностей.

## <a name="the-life-of-a-query"></a>Срок действия запроса

Ниже приведен общий обзор процесса, через который проходит каждый запрос.

1. LINQ-запрос обрабатывается Entity Framework Core для создания представления, которое готово для обработки поставщиком данных.
   1. Результат кэшируется, чтобы не выполнять эту обработку каждый раз при выполнении запроса.
2. Результат передается поставщику базы данных.
   1. Поставщик базы данных определяет, какие части запроса могут выполняться в базе данных.
   2. Эти части запроса преобразуются в язык запроса базы данных (например, SQL для реляционной базы данных).
   3. Один или несколько запросов отправляются в базу данных, и возвращается результирующий набор (результатами являются значения из базы данных, а не экземпляры сущностей).
3. Для каждого элемента в результирующем наборе выполняются следующие действия:
   1. Если это запрос отслеживания, EF проверяет, не предоставляют ли данные сущность, которая уже находится в объекте отслеживания изменений для экземпляра контекста.
      * Если да, возвращается имеющаяся сущность.
      * Если нет, создается другая сущность, устанавливается объект отслеживания изменений и возвращается новая сущность.
   2. Если это не запрос отслеживания, EF проверяет, не предоставляют ли данные сущность, которая уже находится в результирующем наборе для этого запроса.
      * Если да, возвращается имеющаяся сущность<sup>(1)</sup>.
      * Если нет, создается и возвращается другая сущность.

<sup>(1) </sup> В запросах, отличных от запросов отслеживания, используются слабые ссылки для отслеживания сущностей, которые уже были возвращены. Если предыдущий результат с тем же идентификатором выходит за пределы области, а сборка мусора выполняется, вы можете получить новый экземпляр сущности.

## <a name="when-queries-are-executed"></a>Когда выполняются запросы

При вызове операторов LINQ вы просто создаете представление запроса в памяти. Запрос отправляется в базу данных только после обработки результатов.

Ниже приведены наиболее распространенные операции, которые приводят к отправке запроса в базу данных.

* Итерация результатов в цикле `for`.
* Использование оператора, например `ToList`, `ToArray`, `Single`, `Count`.
* Привязка данных результатов запроса к пользовательскому интерфейсу.

> [!WARNING]  
> **Всегда проверяйте входные данные пользователя**. Так как платформа EF Core обеспечивает защиту от атак путем внедрения кода SQL с помощью параметров и экранирования литералов в запросах, она не проверяет входные данные. Поэтому необходимо выполнять проверку в соответствии с требованиями отдельного приложения, прежде чем значения из непроверенного источника будут использоваться в LINQ-запросах, назначенные свойствам сущности или передаваемые другим API EF Core. Сюда входят все входные данные пользователя, используемые для динамического формирования запросов. Даже при использовании LINQ, если вы принимаете входные данные пользователя для создания выражений, необходимо убедиться, что можно создать только предполагаемые выражения.
