---
title: Database First EF6
author: divega
ms.date: 10/23/2016
ms.assetid: cc6ffdb3-388d-4e79-a201-01ec2577c949
ms.openlocfilehash: d40cff4ddccf43a394ef4f244653372a5a89b05a
ms.sourcegitcommit: 708b18520321c587b2046ad2ea9fa7c48aeebfe5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2019
ms.locfileid: "72182454"
---
# <a name="database-first"></a>База данных как основа
Следующее видео и пошаговое руководство познакомят вас с разработкой на основе базы данных в Entity Framework. Такой подход дает возможность реконструировать модель по существующей базе. Модель хранится в EDMX-файле (расширение .emdx), и её можно просмотреть и изменить в Entity Framework Designer. Классы, с которыми вы взаимодействуете в приложении, автоматически создаются из файла EDMX.

## <a name="watch-the-video"></a>Просмотрите видео
Это видео предоставляет общие сведения о разработке на основе базы данных в Entity Framework. Такой подход дает возможность реконструировать модель по существующей базе. Модель хранится в EDMX-файле (расширение .emdx), и её можно просмотреть и изменить в Entity Framework Designer. Классы, с которыми вы взаимодействуете в приложении, автоматически создаются из файла EDMX.

**Представляет**: [Роуэн Миллер (Rowan Miller)](https://romiller.com/)

**Видео**: [WMV](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-winvideo-databasefirst.wmv) | [MP4](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-mp4video-databasefirst.m4v) | [WMV (ZIP)](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-winvideo-databasefirst.zip)

## <a name="pre-requisites"></a>Предварительные требования

Для выполнения инструкций этого пошагового руководства необходимо установить Visual Studio 2010 или Visual Studio 2012.

Если вы используете Visual Studio 2010, также необходимо будет установить [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c).

 

## <a name="1-create-an-existing-database"></a>1. Создание существующей базы данных

Обычно при ориентировании на существующую базу данных она уже будет создана, но в этом пошаговом руководстве нам нужно создать базу данных для доступа.

Сервер базы данных, который устанавливается вместе с Visual Studio, отличается в зависимости от версии Visual Studio, которую вы установили:

-   Если вы используете Visual Studio 2010, вы создадите базу данных SQL Express.
-   Если вы используете Visual Studio 2012, вы создадите базу данных [LocalDB](https://msdn.microsoft.com/library/hh510202(v=sql.110).aspx).

 

Перейдем дальше и создадим базу данных.

-   Запустите Visual Studio.
-   **Вид" —&gt; "Обозреватель сервера**
-   Щелкните правой кнопкой мыши на **Подключения к данным -&gt; Добавить подключение…**
-   Если вы не подключались к базе данных с помощью "Обозревателя сервера" ранее, потребуется выбрать Microsoft SQL Server в качестве источника данных

    ![Выберите источник данных](~/ef6/media/selectdatasource.png)

-   Подключитесь к LocalDB или SQL Express, в зависимости от того, какую из них вы установили, и введите имя базы данных **DatabaseFirst.Blogging**

    ![DF подключения к SQL Express](~/ef6/media/sqlexpressconnectiondf.png)

    ![DF подключения LocalDB](~/ef6/media/localdbconnectiondf.png)

-   Выберите **ОК**, и вам будет задан вопрос, хотите ли вы создать новую базу данных. Выберите **Да**

    ![Диалоговое окно создания базы данных](~/ef6/media/createdatabasedialog.png)

-   Новая база данных появится в Обозревателе сервера. Щелкните ее правой кнопкой мыши и выберите **Новый запрос**
-   Скопируйте следующий код SQL в новый запрос, а затем щелкните запрос правой кнопкой мыши и выберите **Выполнить**

``` SQL
CREATE TABLE [dbo].[Blogs] (
    [BlogId] INT IDENTITY (1, 1) NOT NULL,
    [Name] NVARCHAR (200) NULL,
    [Url]  NVARCHAR (200) NULL,
    CONSTRAINT [PK_dbo.Blogs] PRIMARY KEY CLUSTERED ([BlogId] ASC)
);

CREATE TABLE [dbo].[Posts] (
    [PostId] INT IDENTITY (1, 1) NOT NULL,
    [Title] NVARCHAR (200) NULL,
    [Content] NTEXT NULL,
    [BlogId] INT NOT NULL,
    CONSTRAINT [PK_dbo.Posts] PRIMARY KEY CLUSTERED ([PostId] ASC),
    CONSTRAINT [FK_dbo.Posts_dbo.Blogs_BlogId] FOREIGN KEY ([BlogId]) REFERENCES [dbo].[Blogs] ([BlogId]) ON DELETE CASCADE
);
```

## <a name="2-create-the-application"></a>2. Создание приложения

Для простоты мы создадим простое консольное приложение, использующее подход, основывающийся на базе данных, для выполнения доступа к данным:

-   Запустите Visual Studio.
-   **Файл —&gt; Создать —&gt; Проект…**
-   В меню слева выберите **Windows** и **Консольное приложение**
-   Введите **DatabaseFirstSample** в поле "Имя"
-   Нажмите кнопку **ОК**

 

## <a name="3-reverse-engineer-model"></a>3. реконструирование модели

Для создания нашей модели мы собираемся использовать конструктор Entity Framework Designer, который входит в состав Visual Studio.

-   **Проект -&gt; Добавить новый элемент…**
-   Выберите **Данные** в меню слева и затем **Модель ADO.NET EDM**
-   Введите имя **BloggingModel** и нажмите кнопку **ОК**
-   Это откроет **Мастер моделей EDM**
-   Выберите **Создать из базы данных** и нажмите кнопку **Далее**

    ![Шаг 1 мастера](~/ef6/media/wizardstep1.png)

-   Выберите подключение к базе данных, созданной в первом разделе, введите **BloggingContext** в качестве имени строки подключения и нажмите кнопку **Далее** .

    ![Шаг 2 мастера](~/ef6/media/wizardstep2.png)

-   Установите флажок рядом с пунктом "таблицы", чтобы импортировать все таблицы, и нажмите кнопку "Готово".

    ![Шаг 3 мастера](~/ef6/media/wizardstep3.png)

 

После завершения процесса реконструирования новая модель будет добавлена в проект и откроется для просмотра в Entity Framework Designer. В проект также будет добавлен файл App.config со сведениями о подключении к базе данных.

![Начальная модель](~/ef6/media/modelinitial.png)

### <a name="additional-steps-in-visual-studio-2010"></a>Дополнительные действия в Visual Studio 2010

При работе в Visual Studio 2010 необходимо выполнить некоторые дополнительные действия по обновлению до последней версии Entity Framework. Обновление важно, так как оно предоставляет вам доступ к улучшенным API, которые гораздо проще в использовании, а также последние исправления ошибок.

Сначала необходимо получить последнюю версию Entity Framework из NuGet.

-   **Проект —&gt; Управление пакетами NuGet... ** 
     *При отсутствии пункта **Управление пакетами NuGet… ** следует установить [последнюю версию NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c)*
-   Выберите вкладку **В сети**
-   Выберите пакет **EntityFramework**
-   Нажмите кнопку **Установить**

Далее нам нужно переключить нашу модель, чтобы сгенерировать код, который использует API DbContext, появившийся в более поздних версиях Entity Framework.

-   Щелкните правой кнопкой мыши на пустом месте модели в EF Designer и выберите **Добавить элемент создания кода…**
-   Выберите **Шаблоны в Интернете** из меню слева и выполните поиск **DbContext**
-   Выберите генератор EF **5. x DbContext для C\#** , введите **блоггингмодел** в качестве имени и нажмите кнопку **добавить** .

    ![Шаблон DbContext](~/ef6/media/dbcontexttemplate.png)

 

## <a name="4-reading--writing-data"></a>4. Чтение & запись данных

Теперь, когда у нас есть модель, настала пора использовать ее для доступа к каким-нибудь данным. Классы, которые мы будем использовать для доступа к данным, автоматически создаются в зависимости от EDMX-файла.

*Этот снимок экрана из Visual Studio 2012. Если вы используете Visual Studio 2010, файлы BloggingModel.tt и BloggingModel.Context.tt будут лежать непосредственно в проекте, а не вложены в узел EDMX-файла.*

![Создаваемые классы DF](~/ef6/media/generatedclassesdf.png)

 

Реализуйте метод Main в файле Program.cs так, как показано ниже. Этот код создает новый экземпляр нашего контекста, а затем использует его для вставки новой записи блога. Затем он использует запрос LINQ для извлечения из базы данных всех записей блога, упорядоченных в алфавитном порядке по названию.

``` csharp
class Program
{
    static void Main(string[] args)
    {
        using (var db = new BloggingContext())
        {
            // Create and save a new Blog
            Console.Write("Enter a name for a new Blog: ");
            var name = Console.ReadLine();

            var blog = new Blog { Name = name };
            db.Blogs.Add(blog);
            db.SaveChanges();

            // Display all Blogs from the database
            var query = from b in db.Blogs
                        orderby b.Name
                        select b;

            Console.WriteLine("All blogs in the database:");
            foreach (var item in query)
            {
                Console.WriteLine(item.Name);
            }

            Console.WriteLine("Press any key to exit...");
            Console.ReadKey();
        }
    }
}
```

Теперь можно запустить приложение и протестировать его.

```console
Enter a name for a new Blog: ADO.NET Blog
All blogs in the database:
ADO.NET Blog
Press any key to exit...
```
 

## <a name="5-dealing-with-database-changes"></a>5. Работа с изменениями базы данных

Теперь пора внести некоторые изменения в схему нашей базы данных. Когда мы внесём эти изменения, необходимо также обновить нашу модель, чтобы отразить эти изменения.

Первый шаг — это внесение некоторых изменений в схему базы данных. В схему будет добавлена таблица пользователей.

-   Щелкните правой кнопкой мыши базу данных **DatabaseFirst.Blogging** в Обозревателе сервера и выберите **Создать запрос**
-   Скопируйте следующий код SQL в новый запрос, а затем щелкните запрос правой кнопкой мыши и выберите **Выполнить**

``` SQL
CREATE TABLE [dbo].[Users]
(
    [Username] NVARCHAR(50) NOT NULL PRIMARY KEY,  
    [DisplayName] NVARCHAR(MAX) NULL
)
```

Теперь, когда схема обновлена, пришло время внести изменения в модель.

-   Щелкните правой кнопкой мыши пустое место в модели в конструкторе EF и выберите "обновить модель из базы данных...", после чего запустится мастер обновления.
-   На вкладке "Добавление" мастера обновления установите флажок рядом с таблицами. Это означает, что мы хотим добавить новые таблицы из схемы.
    *На вкладке обновление отображаются все имеющиеся в модели таблицы, которые будут проверяться на наличие изменений во время обновления. На вкладках удаление отображаются все таблицы, которые были удалены из схемы и также будут удалены из модели в рамках обновления. Информация на этих двух вкладках автоматически обнаруживается и предоставляется только в информационных целях, поэтому изменить параметры нельзя.*

    ![Мастер обновления](~/ef6/media/refreshwizard.png)

-   Нажмите кнопку "Готово" в мастере обновления.

 

Теперь модель обновлена. Добавлена новая сущность "Пользователь", которая сопоставляется с таблицей пользователей, которую мы добавили в базу данных.

![Модель обновлена](~/ef6/media/modelupdated.png)

## <a name="summary"></a>Сводка

В этом пошаговом руководстве мы рассмотрели разработку на основе базы данных, которая позволяет создать в EF Designer модель, основываясь на существующей базе. Мы использовали эту модель для чтения и записи некоторых данных в базе. Наконец, мы обновили модель для отражения изменений, внесенных в схему базы данных.
